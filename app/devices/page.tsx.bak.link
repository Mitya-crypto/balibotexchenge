'use client';
import { useEffect, useMemo, useState } from 'react';
import { upsertCurrentDevice, loadDevices, removeDevice, type DeviceInfo } from '../../lib/device';

function fmtTime(ts: number){
  const d = new Date(ts);
  const pad = (n:number)=>String(n).padStart(2,'0');
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}

export default function DevicesPage(){
  const [list,setList]=useState<DeviceInfo[]>([]);

  useEffect(()=>{
    // –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—É—â–µ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∏ –æ–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫
    setList(upsertCurrentDevice());
  },[]);

  const refresh = ()=> setList(loadDevices());
  const del = (id:string)=> setList(removeDevice(id));

  const total = list.length;
  const meId = useMemo(()=> (list.at(0)?.id), [list]); // –ø—Ä–æ—Å—Ç–æ –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞

  return (
    <div className="vstack" style={{gap:16}}>
      <div className="topbar">
        <Link href="/profile">‚Üê –ü—Ä–æ—Ñ–∏–ª—å</a>
      </div>

      <div className="card" style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
        <b>–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</b>
        <div className="muted">–í—Å–µ–≥–æ: {total}</div>
      </div>

      <div className="vstack" style={{gap:10}}>
        {list.length===0 && <div className="card muted">–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö.</div>}
        {list.map((d)=>(
          <div key={d.id} className="li">
            <div className="left">
              <div className="li circle">üì±</div>
              <div style={{display:'flex',flexDirection:'column'}}>
                <b>{d.label}</b>
                <span className="muted" style={{fontSize:12}}>
                  {d.os} ‚Ä¢ {d.browser} ‚Ä¢ {d.platform || '‚Äî'}
                </span>
                <span className="muted" style={{fontSize:12}}>
                  First: {fmtTime(d.tsFirst)} ‚Ä¢ Last: {fmtTime(d.tsLast)}
                </span>
              </div>
            </div>
            <div className="vstack" style={{gap:6, alignItems:'flex-end'}}>
              <button className="btn" onClick={refresh}>–û–±–Ω–æ–≤–∏—Ç—å</button>
              <button className="btn" onClick={()=>del(d.id)} disabled={list.length<=1}>–£–¥–∞–ª–∏—Ç—å</button>
            </div>
          </div>
        ))}
      </div>

      <div className="card muted" style={{fontSize:12}}>
        –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –±–µ–∑ –±—ç–∫–µ–Ω–¥–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞, –∫–æ—Ç–æ—Ä—ã–µ —Å–∞–º–∏ –æ—Ç–∫—Ä—ã–≤–∞–ª–∏ —ç—Ç–æ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∏ –∑–∞–ø–∏—Å–∞–ª–∏—Å—å –≤ localStorage –Ω–∞ —Å–≤–æ—ë–º –±—Ä–∞—É–∑–µ—Ä–µ.
      </div>
    </div>
  );
}
