'use client';
import { useEffect, useMemo, useState } from 'react';
import Link from 'next/link';
import { useAccount, useConnect, useDisconnect, useChainId, useSignMessage } from 'wagmi';
import {
  getCurrentUserKey, listWalletsFor, addEvmWallet,
  addManualWallet, addTronWallet, removeWallet, type WalletRecord
} from '../../lib/wallets';
import { getEmail } from '../../lib/email-util';
import {
  isTronInjected, ensureTronInjected, connectTronLink,
  getUsdtBalance, shortTron, onTronAccountChanged
} from '../../lib/tron';

function short(addr:string){ return addr.length>12 ? addr.slice(0,6)+'‚Ä¶'+addr.slice(-4) : addr; }
const btcRe = /^(bc1|[13])[a-zA-HJ-NP-Z0-9]{25,}$/i;
const tonRe = /^([A-Za-z0-9_\-+:]{48,}|0:[A-Fa-fA-F0-9]{64})$/;
const evmRe = /^0x[a-fA-F0-9]{40}$/;
const tronRe = /^T[1-9A-HJ-NP-Za-km-z]{33}$/;
const hasWC = !!process.env.NEXT_PUBLIC_WC_PROJECT_ID;

export default function WalletsPage(){
  const [{ email, verified }, setMail] = useState<{email?:string; verified:boolean}>({verified:false});
  const userKey = useMemo(()=> (verified && email ? email.toLowerCase() : null), [email, verified]);

  // EVM (wagmi)
  const { address, connector, isConnected, status: accStatus } = useAccount();
  const { connectors, connectAsync, status: connectStatus, error: connectError } = useConnect();
  const { disconnect } = useDisconnect();
  const chainId = useChainId();
  const { signMessageAsync } = useSignMessage();

  // UI state
  const [list, setList] = useState<WalletRecord[]>([]);
  const [btc, setBtc] = useState(''); const [ton, setTon] = useState(''); const [evm, setEvm] = useState('');
  const [err, setErr] = useState(''); const [okMsg, setOkMsg] = useState('');
  const [busy, setBusy] = useState(false);

  // Tron
  const [tronAvailable, setTronAvailable] = useState<'unknown'|'yes'|'no'>('unknown');
  const [tronAddr, setTronAddr] = useState<string>('');
  const [tronManual, setTronManual] = useState<string>(''); // –≤–≤–æ–¥ T-–∞–¥—Ä–µ—Å–∞ –≤—Ä—É—á–Ω—É—é
  const [tronUsdt, setTronUsdt] = useState<number|null>(null);
  const [tronBusy, setTronBusy] = useState(false);
  const [tronApiBusy, setTronApiBusy] = useState(false);

  useEffect(()=>{ setMail(getEmail()); },[]);
  useEffect(()=>{ if(userKey) setList(listWalletsFor(userKey)); },[userKey]);

  useEffect(()=>{
    if (typeof window === 'undefined') return;
    setTronAvailable(isTronInjected() ? 'yes' : 'no');
    const off = onTronAccountChanged((a)=>{
      setTronAddr(a || '');
      if (a && userKey) setList(addTronWallet(userKey, a, 'TronLink'));
      if (a){
        getUsdtBalance(a).then(v=>setTronUsdt(v)).catch(()=>setTronUsdt(null));
      } else {
        setTronUsdt(null);
      }
    });
    return ()=> off();
  },[userKey]);

  // ‚Äî‚Äî‚Äî EVM flows ‚Äî‚Äî‚Äî
  const saveEvm = async ()=>{
    if(!userKey) throw new Error('–ù—É–∂–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å e-mail.');
    if(!address || !connector) throw new Error('–ö–æ—à–µ–ª—ë–∫ –Ω–µ –ø–æ–¥–∫–ª—é—á—ë–Ω.');
    const msg = `Link wallet to ${userKey} at ${new Date().toISOString()}`;
    await signMessageAsync({ message: msg });
    const updated = addEvmWallet(userKey, address, chainId, connector.name);
    setList(updated); setOkMsg('EVM-–∞–¥—Ä–µ—Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω ‚úÖ');
  };

  const connectViaInjected = async ()=>{
    setErr(''); setOkMsg(''); setBusy(true);
    try{
      if(!userKey) throw new Error('–ù—É–∂–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å e-mail.');
      const inj = connectors.find(c =>
        (c.type==='injected' || c.id==='injected' || /MetaMask|Rabby|OKX|Bitget|Brave/i.test(c.name)) && c.ready
      ) || connectors[0];
      if(!inj || !inj.ready) throw new Error('–ù–µ –Ω–∞–π–¥–µ–Ω —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π EVM-–∫–æ—à–µ–ª—ë–∫ (MetaMask/Brave/Rabby/OKX).');
      await connectAsync({ connector: inj });
      await saveEvm();
    }catch(e:any){ setErr(e?.message || connectError?.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å —á–µ—Ä–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ.'); }
    finally{ setBusy(false); }
  };

  const connectViaWalletConnect = async ()=>{
    setErr(''); setOkMsg(''); setBusy(true);
    try{
      if(!userKey) throw new Error('–ù—É–∂–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å e-mail.');
      const wc = connectors.find(c => c.id==='walletConnect' || /WalletConnect/i.test(c.name));
      if(!wc) throw new Error('WalletConnect –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω (NEXT_PUBLIC_WC_PROJECT_ID).');
      await connectAsync({ connector: wc });
      await saveEvm();
    }catch(e:any){ setErr(e?.message || connectError?.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å —á–µ—Ä–µ–∑ WalletConnect.'); }
    finally{ setBusy(false); }
  };

  // ‚Äî‚Äî‚Äî BTC/TON/EVM manual ‚Äî‚Äî‚Äî
  const addBtc = ()=>{
    setErr(''); setOkMsg('');
    if(!userKey){ setErr('–ù—É–∂–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å e-mail.'); return; }
    const a = btc.trim(); if(!btcRe.test(a)){ setErr('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π BTC –∞–¥—Ä–µ—Å'); return; }
    setList(addManualWallet(userKey, 'btc', a, 'BTC')); setBtc(''); setOkMsg('BTC –∞–¥—Ä–µ—Å –¥–æ–±–∞–≤–ª–µ–Ω ‚úÖ');
  };
  const addTon = ()=>{
    setErr(''); setOkMsg('');
    if(!userKey){ setErr('–ù—É–∂–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å e-mail.'); return; }
    const a = ton.trim(); if(!tonRe.test(a)){ setErr('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π TON –∞–¥—Ä–µ—Å'); return; }
    setList(addManualWallet(userKey, 'ton', a, 'TON')); setTon(''); setOkMsg('TON –∞–¥—Ä–µ—Å –¥–æ–±–∞–≤–ª–µ–Ω ‚úÖ');
  };
  const addEvmManual = ()=>{
    setErr(''); setOkMsg('');
    if(!userKey){ setErr('–ù—É–∂–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å e-mail.'); return; }
    const a = evm.trim(); if(!evmRe.test(a)){ setErr('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π EVM –∞–¥—Ä–µ—Å (0x...)'); return; }
    setList(addManualWallet(userKey, 'evm', a, 'EVM')); setEvm(''); setOkMsg('EVM –∞–¥—Ä–µ—Å –¥–æ–±–∞–≤–ª–µ–Ω –≤—Ä—É—á–Ω—É—é ‚úÖ');
  };

  // ‚Äî‚Äî‚Äî TronLink ‚Äî‚Äî‚Äî
  const connectTron = async ()=>{
    setErr(''); setOkMsg(''); setTronBusy(true);
    try{
      if(!userKey) throw new Error('–ù—É–∂–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å e-mail.');
      try { await ensureTronInjected(); setTronAvailable('yes'); }
      catch { setTronAvailable('no'); throw new Error('TronLink –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.'); }
      const { address } = await connectTronLink(); // T...
      setTronAddr(address);
      setList(addTronWallet(userKey, address, 'TronLink'));
      try{ setTronUsdt(null); const bal = await getUsdtBalance(address); setTronUsdt(bal); }catch{ setTronUsdt(null); }
      setOkMsg('TRON –∞–¥—Ä–µ—Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω ‚úÖ');
    }catch(e:any){ setErr(e?.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å TronLink.'); }
    finally{ setTronBusy(false); }
  };

  // ‚Äî‚Äî‚Äî TRON manual + API fallback ‚Äî‚Äî‚Äî
  const addTronManual = ()=>{
    setErr(''); setOkMsg('');
    if(!userKey){ setErr('–ù—É–∂–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å e-mail.'); return; }
    const a = tronManual.trim(); if(!tronRe.test(a)){ setErr('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π TRON –∞–¥—Ä–µ—Å (–æ–∂–∏–¥–∞–µ–º T...)'); return; }
    setList(addManualWallet(userKey, 'tron', a, 'TRON'));
    setTronAddr(a);
    setTronManual('');
    setOkMsg('TRON –∞–¥—Ä–µ—Å –¥–æ–±–∞–≤–ª–µ–Ω –≤—Ä—É—á–Ω—É—é ‚úÖ');
  };

  const tronSaved = useMemo(()=> list.find(w=>w.kind==='tron')?.address, [list]);
  const refreshTronUsdtViaApi = async ()=>{
    const a = tronAddr || tronSaved;
    if(!a){ setErr('–ù–µ—Ç TRON –∞–¥—Ä–µ—Å–∞. –í–≤–µ–¥–∏—Ç–µ –≤—Ä—É—á–Ω—É—é –∏–ª–∏ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ TronLink.'); return; }
    setTronApiBusy(true); setErr(''); setOkMsg('');
    try{
      const r = await fetch(`/api/tron/usdt?address=${a}`);
      const j = await r.json();
      if(!r.ok) throw new Error(j?.error || 'API error');
      setTronUsdt(Number(j.usdt||0));
      setOkMsg('–ë–∞–ª–∞–Ω—Å USDT –æ–±–Ω–æ–≤–ª—ë–Ω (API) ‚úÖ');
    }catch(e:any){
      setErr(e?.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –±–∞–ª–∞–Ω—Å —á–µ—Ä–µ–∑ API.');
    }finally{
      setTronApiBusy(false);
    }
  };

  const del = (id:string)=>{ if(!userKey) return; setOkMsg(''); setErr(''); setList(removeWallet(userKey,id)); };

  if(!verified){
    return (
      <div className="vstack" style={{gap:16}}>
        <div className="topbar"><Link href="/profile">‚Üê –ü—Ä–æ—Ñ–∏–ª—å</Link></div>
        <div className="card">
          <b>–ü—Ä–∏–≤—è–∑–∫–∞ –∫–æ—à–µ–ª—å–∫–æ–≤ –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è e-mail.</b>
          <div className="hstack" style={{marginTop:12, gap:12}}>
            <Link href="/email" className="btn primary">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å e-mail</Link>
            <Link href="/profile" className="btn">–í–µ—Ä–Ω—É—Ç—å—Å—è</Link>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="vstack" style={{gap:16}}>
      <div className="topbar"><Link href="/profile">‚Üê –ü—Ä–æ—Ñ–∏–ª—å</Link></div>

      <div className="card" style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
        <b>–ö–æ—à–µ–ª—å–∫–∏</b>
        <span className="muted" style={{fontSize:12}}>{email}</span>
      </div>

      {/* TRON / TronLink + API —Ñ–æ–ª–±—ç–∫ */}
      <div className="card vstack" style={{gap:12}}>
        <b>TRON (USDT TRC20)</b>

        <div className="hstack" style={{gap:12, flexWrap:'wrap'}}>
          <button className="btn primary" onClick={connectTron} disabled={tronBusy}>
            {tronBusy ? '–ü–æ–¥–∫–ª—é—á–∞–µ–º TronLink‚Ä¶' : '–ü–æ–¥–∫–ª—é—á–∏—Ç—å TronLink'}
          </button>
          <button className="btn" onClick={refreshTronUsdtViaApi} disabled={tronApiBusy}>
            {tronApiBusy ? '–û–±–Ω–æ–≤–ª—è–µ–º‚Ä¶' : '–ë–∞–ª–∞–Ω—Å —á–µ—Ä–µ–∑ API'}
          </button>
        </div>

        {tronAvailable==='no' && (
          <div className="muted" style={{fontSize:12}}>
            TronLink –Ω–µ –Ω–∞–π–¥–µ–Ω. –ú–æ–∂–Ω–æ <b>–≤–≤–µ—Å—Ç–∏ T-–∞–¥—Ä–µ—Å –≤—Ä—É—á–Ω—É—é</b> –∏ –ø–æ–ª—É—á–∏—Ç—å –±–∞–ª–∞–Ω—Å —á–µ—Ä–µ–∑ TronScan API.
          </div>
        )}

        {/* –†—É—á–Ω–æ–π –≤–≤–æ–¥ TRON */}
        <div className="grid2">
          <div className="vstack" style={{gap:8}}>
            <label><b>TRON –∞–¥—Ä–µ—Å</b></label>
            <input value={tronManual} onChange={e=>setTronManual(e.target.value)} placeholder="T..." style={{padding:'10px',border:'1px solid var(--border)',borderRadius:'12px'}}/>
            <button className="btn" onClick={addTronManual}>–î–æ–±–∞–≤–∏—Ç—å TRON –≤—Ä—É—á–Ω—É—é</button>
          </div>
        </div>

        {(tronAddr || tronSaved) && (
          <div className="li">
            <div className="left">
              <div className="li circle">üü£</div>
              <div>
                <b>TRON</b>
                <div className="muted" style={{fontSize:12}}>{shortTron(tronAddr || tronSaved!)}</div>
              </div>
            </div>
            <div>
              <b>{tronUsdt!=null ? `${tronUsdt.toLocaleString('ru-RU',{maximumFractionDigits:2})} USDT` : '‚Äî'}</b>
            </div>
          </div>
        )}
      </div>

      {/* EVM: —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –∏ WalletConnect */}
      <div className="card vstack" style={{gap:12}}>
        <b>EVM —á–µ—Ä–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ</b>
        <button className="btn" onClick={connectViaInjected} disabled={busy || accStatus==='connecting' || connectStatus==='pending'}>
          {busy || connectStatus==='pending' ? '–ü–æ–¥–∫–ª—é—á–∞–µ–º‚Ä¶' : '–ü–æ–¥–∫–ª—é—á–∏—Ç—å (MetaMask/Rabby/OKX)'}
        </button>
        {isConnected && address && (
          <div className="li">
            <div className="left">
              <div className="li circle">‚õìÔ∏è</div>
              <div><b>{connector?.name || 'Wallet'}</b><div className="muted" style={{fontSize:12}}>{short(address)} ‚Ä¢ chainId {chainId}</div></div>
            </div>
            <button className="btn" onClick={()=>disconnect()}>–û—Ç–∫–ª—é—á–∏—Ç—å</button>
          </div>
        )}
      </div>
      <div className="card vstack" style={{gap:12}}>
        <b>EVM —á–µ—Ä–µ–∑ WalletConnect</b>
        <button className="btn" onClick={connectViaWalletConnect} disabled={busy || accStatus==='connecting' || connectStatus==='pending' || !hasWC}>
          {hasWC ? (busy ? '–ü–æ–¥–∫–ª—é—á–∞–µ–º‚Ä¶' : '–ü–æ–¥–∫–ª—é—á–∏—Ç—å (QR/–º–æ–±–∏–ª—å–Ω—ã–π)') : 'WalletConnect –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω'}
        </button>
        {!hasWC && <div className="muted" style={{fontSize:12}}>–£–∫–∞–∂–∏—Ç–µ <code>NEXT_PUBLIC_WC_PROJECT_ID</code> –≤ <code>.env.local</code>.</div>}
      </div>

      {/* –†—É—á–Ω—ã–µ –∞–¥—Ä–µ—Å–∞ */}
      <div className="card vstack" style={{gap:12}}>
        <b>–î–æ–±–∞–≤–∏—Ç—å –≤—Ä—É—á–Ω—É—é</b>
        <div className="grid2">
          <div className="vstack" style={{gap:8}}>
            <label><b>BTC –∞–¥—Ä–µ—Å</b></label>
            <input value={btc} onChange={e=>setBtc(e.target.value)} placeholder="bc1..." style={{padding:'10px',border:'1px solid var(--border)',borderRadius:'12px'}}/>
            <button className="btn" onClick={addBtc}>–î–æ–±–∞–≤–∏—Ç—å BTC</button>
          </div>
          <div className="vstack" style={{gap:8}}>
            <label><b>TON –∞–¥—Ä–µ—Å</b></label>
            <input value={ton} onChange={e=>setTon(e.target.value)} placeholder="EQ... / 0:..." style={{padding:'10px',border:'1px solid var(--border)',borderRadius:'12px'}}/>
            <button className="btn" onClick={addTon}>–î–æ–±–∞–≤–∏—Ç—å TON</button>
          </div>
          <div className="vstack" style={{gap:8}}>
            <label><b>EVM –∞–¥—Ä–µ—Å</b></label>
            <input value={evm} onChange={e=>setEvm(e.target.value)} placeholder="0x..." style={{padding:'10px',border:'1px solid var(--border)',borderRadius:'12px'}}/>
            <button className="btn" onClick={addEvmManual}>–î–æ–±–∞–≤–∏—Ç—å EVM –≤—Ä—É—á–Ω—É—é</button>
          </div>
        </div>
      </div>

      {/* –°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∫–æ—à–µ–ª—å–∫–∏ */}
      <div className="vstack" style={{gap:10}}>
        {list.length===0 && <div className="card muted">–ü–æ–∫–∞ –Ω–µ—Ç –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã—Ö –∫–æ—à–µ–ª—å–∫–æ–≤.</div>}
        {list.map(w=>(
          <div key={w.id} className="li">
            <div className="left">
              <div className="li circle">{w.kind==='evm'?'‚õìÔ∏è':w.kind==='tron'?'üü£':'üí≥'}</div>
              <div style={{display:'flex',flexDirection:'column'}}>
                <b>{w.label || w.kind.toUpperCase()} {w.kind==='evm' && w.chainId ? `(chainId ${w.chainId})` : ''}</b>
                <span className="muted" style={{fontSize:12}}>{w.kind==='tron'? shortTron(w.address) : short(w.address)}{w.connector?` ‚Ä¢ ${w.connector}`:''}</span>
              </div>
            </div>
            <button className="btn" onClick={()=>del(w.id)}>–£–¥–∞–ª–∏—Ç—å</button>
          </div>
        ))}
      </div>

      {okMsg && <div className="card" style={{borderColor:'var(--good)', color:'var(--good)'}}>{okMsg}</div>}
      {err && <div className="card" style={{borderColor:'var(--danger)', color:'var(--danger)'}}>{err}</div>}

      <div className="card muted" style={{fontSize:12}}>
        –§–æ–ª–±—ç–∫ ¬´–ë–∞–ª–∞–Ω—Å —á–µ—Ä–µ–∑ API¬ª –∏—Å–ø–æ–ª—å–∑—É–µ—Ç TronScan <code>account/tokens</code> –∏ USDT –∫–æ–Ω—Ç—Ä–∞–∫—Ç <code>TR7NHqje...</code>.
      </div>
    </div>
  );
}
